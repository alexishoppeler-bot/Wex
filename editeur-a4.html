<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√âditeur PDF A4</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink:#111;
      --ink-soft:#4a5b6b;
      --panel:#fff;
      --accent:#1e6bd6;
      --accent-soft:#e8f0ff;
      --border:#dadde1;
    }
    html,body{height:100%;margin:0;font-family:'Open Sans', Arial, sans-serif;background:linear-gradient(180deg,#f3f6fb 0%,#ffffff 45%);color:var(--ink);}
    body.print-mode{background:#fff;}
    .exercise-card{padding:32px clamp(16px,5vw,48px);}
    .back-home{position:fixed;bottom:24px;right:clamp(12px,4vw,40px);margin:0;padding:0;z-index:90;}
    .back-home__link{display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:#004c6d;font-weight:700;border:1px solid #cfdff0;padding:10px 18px;border-radius:999px;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,0.15);backdrop-filter:blur(4px);}
    .wrap{display:flex;flex-direction:column;gap:16px;margin:0 auto;max-width:1160px;}
    .editor-hero{display:flex;flex-wrap:wrap;gap:18px;background:var(--panel);border-radius:24px;border:1px solid rgba(30,107,214,0.15);padding:24px;box-shadow:0 20px 60px rgba(17,23,33,0.12);}
    .hero-badge{display:inline-flex;background:#f4f8ff;color:#2d6cdf;padding:4px 12px;border-radius:999px;font-weight:700;font-size:0.85rem;margin-bottom:10px;}
    .hero-text{flex:1 1 360px;}
    .hero-text h1{margin:0 0 4px;font-size:1.7rem;color:var(--ink);}
    .hero-text p{margin:4px 0;color:var(--ink-soft);line-height:1.5;}
    .hero-pill-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
    .hero-pill{background:var(--accent-soft);color:var(--accent);padding:6px 14px;border-radius:999px;font-weight:600;font-size:.9rem;}
    .hero-meta{flex:1 1 220px;display:flex;flex-direction:column;gap:12px;align-items:flex-start;}
    .save-indicator{font-weight:700;font-size:1rem;padding:10px 16px;border-radius:14px;border:1px dashed rgba(30,107,214,0.4);color:var(--accent);}
    .save-indicator.is-pending{color:#b45f06;border-color:#f0bc7b;background:#fff8ed;}
    .save-indicator.is-done{color:#1a8c6d;border-color:#7bd1a7;background:#f1fff8;}
    .doc-meta{display:flex;gap:12px;flex-wrap:wrap;}
    .doc-meta span{background:var(--accent-soft);color:var(--ink);padding:6px 12px;border-radius:10px;font-weight:600;}

    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;}
    .info-card{background:var(--panel);border-radius:18px;padding:18px 20px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(17,23,33,0.08);}
    .info-card h3{margin:0 0 6px;font-size:1.05rem;color:var(--ink);}
    .info-card p,.info-card ul{margin:0;color:var(--ink-soft);font-size:0.95rem;line-height:1.45;padding-left:18px;}

    .toolbar-block{display:flex;flex-direction:column;gap:10px;}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:0 4px 15px rgba(17,23,33,0.08);}
    .toolbar--secondary{justify-content:flex-end;background:rgba(255,255,255,0.85);}
    .tool-group{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
    .tool-label{font-size:0.85rem;font-weight:700;color:var(--ink-soft);margin-right:4px;}

    .btn,select{display:inline-flex;align-items:center;justify-content:center;height:38px;border:1px solid var(--border);background:var(--panel);border-radius:10px;cursor:pointer;font-weight:600;font-size:0.95rem;color:var(--ink);transition:all .15s ease;padding:0 10px;}
    .btn:hover,select:hover{border-color:var(--accent);background:#f0f6ff}
    .btn.active,[aria-pressed="true"]{background:#cce0ff;border-color:var(--accent);}
    .btn img{width:22px;height:22px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .btn--ghost{background:transparent;border-style:dashed;}
    .btn--danger{border-color:#ffb0b0;color:#b4002f;}

    .editor-container{background:linear-gradient(135deg,#f5f7fb,#fafafa);padding:24px;border-radius:24px;border:1px solid rgba(17,23,33,0.05);box-shadow:0 25px 45px rgba(17,23,33,0.12);display:flex;justify-content:center;align-items:center;}
    .editor{background:#fff;width:210mm;height:297mm;padding:25.4mm;box-sizing:border-box;line-height:1.55;font-size:16px;overflow:auto;color:#777;border-radius:12px;box-shadow:0 35px 60px rgba(0,0,0,0.12);border:1px solid #f0f0f0;}
    .editor[data-placeholder="true"]{color:#9da7b3;}
    .editor:focus{outline:3px solid rgba(30,107,214,0.25);}
    .editor ol,.editor ul{font:inherit;color:inherit;margin-left:1.2rem;}
    .editor li{font:inherit;color:inherit;margin-bottom:4px;}
    .editor ol li::marker,.editor ul li::marker{color:inherit;font:inherit;}

    .color-split{display:inline-flex;align-items:center;position:relative;}
    .color-main{position:relative;padding:0 10px;}
    .color-main .A{font-weight:800;font-size:18px;line-height:1;}
    .color-main .swatch{position:absolute;left:8px;right:8px;bottom:5px;height:3px;border-radius:2px;background:#111;}
    .color-palette{display:none;position:absolute;top:42px;left:0;background:#fff;border:1px solid #dadde1;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.12);padding:8px;z-index:30}
    .color-grid{display:grid;grid-template-columns:repeat(10,20px);gap:6px}
    .color-cell{width:20px;height:20px;border:1px solid #cfd3d8;border-radius:4px;cursor:pointer}
    .color-cell:hover{outline:2px solid #2d6cdf;outline-offset:1px}

    @media (max-width:900px){
      .editor{width:100%;height:calc(100vh - 220px);}
      .editor-container{padding:16px;}
    }
    @media (max-width:640px){
      .hero-meta{align-items:stretch;}
      .toolbar{justify-content:center;}
      .toolbar--secondary{justify-content:center;}
      .doc-meta{justify-content:center;}
    }

    body.print-mode .print-hide{display:none!important;}
    body.print-mode .editor-container{padding:0;border:none;box-shadow:none;}
    body.print-mode .editor{width:auto!important;min-height:auto!important;height:auto!important;box-shadow:none!important;border:none!important;margin:0 auto!important;padding:25.4mm!important;}

    @media print{
      body{background:#fff;}
      .print-hide{display:none!important;}
      .editor-container{padding:0!important;border:none!important;box-shadow:none!important;}
      .editor{width:auto!important;min-height:auto!important;height:auto!important;box-shadow:none!important;border:none!important;margin:0 auto!important;padding:25.4mm!important;}
    }

    @page{
      size:A4;
      margin:0;
    }
  </style>
  <link rel="stylesheet" href="../../exercise-layout.css">
  <script defer src="../../exercise-layout.js"></script>
</head>
<body>

<div class="back-home print-hide">
  <a class="back-home__link" href="../../index.html">‚Üê Menu</a>
</div>
<script src="../shared/proactif-exercise.js"></script>
<div class="exercise-shell">
  <main class="exercise-card">


  <div class="wrap">
    <section class="editor-hero print-hide">
      <div class="hero-text">
        <span class="hero-badge">Bureautique ‚Ä¢ Mode A4</span>
        <h1>Composez votre document professionnel</h1>
        <p>Cr√©ez des comptes rendus, lettres ou fiches p√©dagogiques directement au format A4. Tous vos textes sont enregistr√©s automatiquement dans ce navigateur.</p>
        <div class="hero-pill-row">
          <span class="hero-pill">Format A4 imprimable</span>
          <span class="hero-pill">Sauvegarde locale</span>
          <span class="hero-pill">Export PDF haute r√©solution</span>
        </div>
      </div>
      <div class="hero-meta">
        <div class="save-indicator" id="saveIndicator">Sauvegarde locale active</div>
        <div class="doc-meta">
          <span id="wordCount">0 mot</span>
          <span id="charCount">0 caract√®re</span>
        </div>
      </div>
    </section>

    <div class="info-grid print-hide">
      <article class="info-card">
        <h3>1. R√©diger</h3>
        <p>S√©lectionnez une police, tapez vos paragraphes et utilisez les styles pour hi√©rarchiser vos id√©es.</p>
      </article>
      <article class="info-card">
        <h3>2. Structurer</h3>
        <ul>
          <li>Appliquez les listes et retraits.</li>
          <li>Choisissez l‚Äôalignement adapt√©.</li>
          <li>Ajoutez un mod√®le pr√™t √† remplir.</li>
        </ul>
      </article>
      <article class="info-card">
        <h3>3. Finaliser</h3>
        <p>Contr√¥lez le compteur de mots, sauvegardez automatiquement puis exportez votre PDF professionnel.</p>
      </article>
    </div>

    <div class="toolbar-block print-hide">
      <div class="toolbar">
        <div class="tool-group">
          <span class="tool-label">Historique</span>
          <button class="btn" id="undo" title="Annuler (Ctrl+Z)">‚Ü∂</button>
        </div>

        <div class="tool-group">
          <span class="tool-label">Police</span>
          <select id="fontSelect" title="Police">
            <option value="Open Sans" selected>Open Sans</option>
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Calibri">Calibri</option>
            <option value="Verdana">Verdana</option>
          </select>

          <select id="fontSizeSelect" title="Taille">
            <option value="12px">12</option>
            <option value="14px" selected>14</option>
            <option value="16px">16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="24px">24</option>
          </select>
        </div>

        <div class="tool-group">
          <span class="tool-label">Couleur</span>
          <div class="color-split" id="fontColorControl" title="Couleur du texte">
            <button class="btn color-main" id="fontColorApply" type="button" aria-label="Couleur du texte">
              <span class="A">A</span>
              <span class="swatch" id="fontColorSwatch"></span>
            </button>
            <div class="color-palette" id="fontColorPalette" role="menu" aria-label="Palette de couleurs"></div>
          </div>
        </div>

        <div class="tool-group">
          <span class="tool-label">Style</span>
          <button class="btn" data-cmd="bold" title="Gras (Ctrl+B)"><b>G</b></button>
          <button class="btn" data-cmd="italic" title="Italique (Ctrl+I)"><i>I</i></button>
          <button class="btn" data-cmd="underline" title="Soulign√© (Ctrl+U)"><u>S</u></button>
        </div>

        <div class="tool-group">
          <span class="tool-label">Listes</span>
          <button class="btn" id="btn-ul" title="Liste √† puces">
            <img src="https://img.icons8.com/ios-filled/50/000000/bulleted-list.png" alt="Liste √† puces">
          </button>
          <button class="btn" id="btn-ol" title="Liste num√©rot√©e">
            <img src="https://img.icons8.com/ios-filled/50/000000/numbered-list.png" alt="Liste num√©rot√©e">
          </button>
        </div>

        <div class="tool-group">
          <span class="tool-label">Alignement</span>
          <button class="btn align" title="Aligner √† gauche" data-align="left">
            <img src="https://img.icons8.com/ios-filled/50/000000/align-left.png" alt="Aligner √† gauche">
          </button>
          <button class="btn align" title="Centrer" data-align="center">
            <img src="https://img.icons8.com/ios-filled/50/000000/align-center.png" alt="Centrer">
          </button>
          <button class="btn align" title="Aligner √† droite" data-align="right">
            <img src="https://img.icons8.com/ios-filled/50/000000/align-right.png" alt="Aligner √† droite">
          </button>
          <button class="btn align" title="Justifier" data-align="justify">
            <img src="https://img.icons8.com/ios-filled/50/000000/align-justify.png" alt="Justifier">
          </button>
        </div>

        <div class="tool-group">
          <span class="tool-label">Retrait</span>
          <button class="btn" id="btn-indent10" title="Retrait gauche 10 cm (activer/d√©sactiver)">
            <svg width="22" height="22" viewBox="0 0 22 22" aria-hidden="true">
              <line x1="12" y1="6" x2="20" y2="6" stroke="#333" stroke-width="2" stroke-linecap="round"/>
              <line x1="12" y1="11" x2="20" y2="11" stroke="#333" stroke-width="2" stroke-linecap="round"/>
              <line x1="12" y1="16" x2="20" y2="16" stroke="#333" stroke-width="2" stroke-linecap="round"/>
              <line x1="4" y1="11" x2="10" y2="11" stroke="#1e6bd6" stroke-width="2" stroke-linecap="round"/>
              <polygon points="10,11 7,8 7,14" fill="#1e6bd6"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="toolbar toolbar--secondary">
        <button class="btn btn--ghost" id="btn-template" type="button" title="Ins√©rer un mod√®le pr√™t √† remplir">üìÑ Mod√®le rapide</button>
        <button class="btn btn--ghost btn--danger" id="btn-clear" type="button" title="Vider le document">üóëÔ∏è R√©initialiser</button>
        <button class="btn" id="btn-pdf" type="button" title="Imprimer ou enregistrer en PDF">üñ®Ô∏è Imprimer / PDF</button>
      </div>
    </div>

    <div class="editor-container">
      <div id="editor" class="editor" data-placeholder="true" contenteditable="true">Tapez ici...</div>
    </div>
  </div>
  <script>
    const editor = document.getElementById('editor');
    const undoBtn = document.getElementById('undo');
    const formatBtns = document.querySelectorAll('.btn[data-cmd]');
    const alignBtns = document.querySelectorAll('.btn.align');
    const ulBtn = document.getElementById('btn-ul');
    const olBtn = document.getElementById('btn-ol');
    const indentBtn = document.getElementById('btn-indent10');
    const pdfBtn = document.getElementById('btn-pdf');
    const fontSelect = document.getElementById('fontSelect');
    const fontSizeSelect = document.getElementById('fontSizeSelect');
    const colorApply = document.getElementById('fontColorApply');
    const colorPalette = document.getElementById('fontColorPalette');
    const colorSwatch = document.getElementById('fontColorSwatch');
    const templateBtn = document.getElementById('btn-template');
    const clearBtn = document.getElementById('btn-clear');
    const saveIndicator = document.getElementById('saveIndicator');
    const wordCountEl = document.getElementById('wordCount');
    const charCountEl = document.getElementById('charCount');

    const STORAGE_CONTENT_KEY = 'editeur_a4_content_v1';
    const AUTOSAVE_DELAY = 600;
    const PLACEHOLDER_TEXT = 'Tapez ici...';
    const alignCommandMap = {left:'justifyLeft', center:'justifyCenter', right:'justifyRight', justify:'justifyFull'};

    let history = [];
    let position = 0;
    let savedRange = null;
    let saveTimer = null;
    let saveMessageTimer = null;

    function selectionInsideEditor(sel){
      if(!sel || sel.rangeCount===0) return false;
      const n = sel.getRangeAt(0).commonAncestorContainer;
      return editor.contains(n.nodeType===1? n : n.parentNode);
    }
    function saveSelection(){
      const sel = window.getSelection();
      if(selectionInsideEditor(sel)) savedRange = sel.getRangeAt(0).cloneRange();
    }
    function restoreSelection(){
      if(!savedRange) return false;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedRange);
      return true;
    }

    function isPlaceholderActive(){
      return editor.dataset.placeholder === 'true';
    }
    function setPlaceholder(){
      editor.textContent = PLACEHOLDER_TEXT;
      editor.dataset.placeholder = 'true';
      editor.style.color = '#777';
    }
    function removePlaceholder(){
      if(isPlaceholderActive()){
        editor.textContent = '';
      }
      editor.dataset.placeholder = 'false';
      editor.style.color = '#111';
    }

    function loadInitialContent(){
      const saved = localStorage.getItem(STORAGE_CONTENT_KEY);
      if(saved){
        editor.innerHTML = saved;
        editor.dataset.placeholder = 'false';
        editor.style.color = '#111';
      }else{
        setPlaceholder();
      }
      history = [editor.innerHTML];
      position = 0;
      updateCounts();
      updateButtons();
      showSaved('Sauvegarde locale active', true);
    }

    function record(){
      const html = editor.innerHTML;
      if(history[position] !== html){
        history = history.slice(0, position + 1);
        history.push(html);
        position = history.length - 1;
      }
      updateButtons();
    }

    function updateButtons(){
      undoBtn.disabled = position === 0;
      updateIndentState();
      updateAlignState();
    }

    function undo(){
      if(position>0){
        position--;
        editor.innerHTML = history[position];
        if(!editor.textContent.trim()){
          setPlaceholder();
        }else{
          editor.dataset.placeholder='false';
          editor.style.color='#111';
        }
        updateCounts();
        updateButtons();
        scheduleSave();
      }
    }

    function getActiveBlockFrom(node){
      let el = node && (node.nodeType===1? node : node.parentNode);
      while(el && el!==editor && !/^(P|DIV|LI|H1|H2|H3|H4|H5|H6)$/i.test(el.tagName)) el = el.parentNode;
      return (el && el!==editor)? el : null;
    }
    function blocksInSelection(){
      const sel = window.getSelection();
      if(!sel || sel.rangeCount===0 || !selectionInsideEditor(sel)) return [];
      const range = sel.getRangeAt(0);
      if(sel.isCollapsed){
        const blk = getActiveBlockFrom(range.startContainer);
        return blk? [blk] : [];
      }
      const common = range.commonAncestorContainer.nodeType===1? range.commonAncestorContainer : range.commonAncestorContainer.parentNode;
      const isBlock = el=> el && el.tagName && /^(P|DIV|LI|UL|OL|H1|H2|H3|H4|H5|H6)$/i.test(el.tagName);
      const out = new Set();
      const addEdge = node => { const e=getActiveBlockFrom(node); if(e) out.add(e); };
      addEdge(range.startContainer); addEdge(range.endContainer);
      const walker = document.createTreeWalker(common, NodeFilter.SHOW_ELEMENT, null);
      let n; while((n=walker.nextNode())) if(isBlock(n)){
        try{ const r=document.createRange(); r.selectNodeContents(n);
          if(range.compareBoundaryPoints(Range.END_TO_START,r)<0 && range.compareBoundaryPoints(Range.START_TO_END,r)>0) out.add(n);
        }catch{}
      }
      return Array.from(out);
    }
    function ensureBlocks(){
      let blocks = blocksInSelection();
      if(blocks.length>0) return blocks;
      const sel = window.getSelection();
      if(!sel || sel.rangeCount===0) return [];
      const range = sel.getRangeAt(0);
      const existing = getActiveBlockFrom(range.startContainer);
      if(existing) return [existing];
      const p = document.createElement('p');
      if(!sel.isCollapsed){
        const frag = range.extractContents(); p.appendChild(frag); range.insertNode(p);
      }else{
        p.appendChild(document.createTextNode('\u00A0'));
        range.insertNode(p);
        const r=document.createRange(); r.selectNodeContents(p); r.collapse(false);
        sel.removeAllRanges(); sel.addRange(r);
      }
      return [p];
    }

    function updateIndentState(){
      const blocks = blocksInSelection();
      const active = blocks.length>0 && blocks.every(b=> (b.style.marginLeft||'')==='10cm');
      indentBtn.classList.toggle('active', active);
    }

    function updateAlignState(){
      const sel = window.getSelection();
      alignBtns.forEach(btn=>{
        const cmd = alignCommandMap[btn.dataset.align];
        if(!cmd) return;
        let state = false;
        if(selectionInsideEditor(sel) && document.queryCommandState){
          try{ state = document.queryCommandState(cmd); }catch(e){ state = false; }
        }
        btn.classList.toggle('active', !!state);
      });
    }

    function scheduleSave(){
      showSaving();
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>persistContent(false), AUTOSAVE_DELAY);
    }

    function showSaving(){
      if(!saveIndicator) return;
      saveIndicator.textContent = 'Enregistrement‚Ä¶';
      saveIndicator.classList.add('is-pending');
      saveIndicator.classList.remove('is-done');
    }

    function showSaved(message, sticky){
      if(!saveIndicator) return;
      saveIndicator.textContent = message || 'Sauvegard√© ‚úì';
      saveIndicator.classList.remove('is-pending');
      saveIndicator.classList.add('is-done');
      clearTimeout(saveMessageTimer);
      if(!sticky){
        saveMessageTimer = setTimeout(()=>{
          saveIndicator.textContent = 'Sauvegarde locale active';
          saveIndicator.classList.remove('is-done');
        }, 2400);
      }
    }

    function persistContent(immediate){
      clearTimeout(saveTimer);
      if(isPlaceholderActive() || !editor.textContent.trim()){
        localStorage.removeItem(STORAGE_CONTENT_KEY);
        showSaved('Pr√™t', immediate);
        return;
      }
      localStorage.setItem(STORAGE_CONTENT_KEY, editor.innerHTML);
      showSaved('Sauvegard√© ‚úì', immediate);
    }

    function updateCounts(){
      if(!wordCountEl || !charCountEl) return;
      if(isPlaceholderActive()){
        wordCountEl.textContent = '0 mot';
        charCountEl.textContent = '0 caract√®re';
        return;
      }
      const raw = (editor.innerText || '').replace(/\u00a0/g,' ').replace(/\r/g,'');
      const cleaned = raw.trim();
      const words = cleaned ? cleaned.split(/\s+/).length : 0;
      const chars = raw.replace(/\n/g,'').length;
      wordCountEl.textContent = `${words} mot${words>1?'s':''}`;
      charCountEl.textContent = `${chars} caract√®re${chars>1?'s':''}`;
    }

    function placeCursorAtEnd(){
      const range = document.createRange();
      range.selectNodeContents(editor);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    editor.addEventListener('input',()=>{
      if(isPlaceholderActive()){
        removePlaceholder();
      }
      record();
      updateIndentState();
      updateCounts();
      scheduleSave();
    });
    editor.addEventListener('mouseup', ()=>{ updateIndentState(); updateAlignState(); });
    editor.addEventListener('keyup', ()=>{ updateIndentState(); updateAlignState(); updateCounts(); });
    document.addEventListener('selectionchange', ()=>{
      if(selectionInsideEditor(window.getSelection())){
        updateIndentState();
        updateAlignState();
      }
    });

    editor.addEventListener('focus', removePlaceholder);
    editor.addEventListener('blur', ()=>{
      if(!editor.textContent.trim()){
        setPlaceholder();
        updateCounts();
        scheduleSave();
      }
    });

    undoBtn.addEventListener('click',undo);

    document.addEventListener('keydown',e=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){e.preventDefault();undo();}
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){e.preventDefault();persistContent(true);}
    });

    formatBtns.forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.execCommand(btn.dataset.cmd,false,null);
        editor.focus();
        record();
        updateCounts();
        scheduleSave();
      });
    });

    fontSelect.addEventListener('change',()=>{
      document.execCommand('fontName',false,fontSelect.value);
      editor.focus();
      record();
      scheduleSave();
    });

    fontSizeSelect.addEventListener('change',()=>{
      document.execCommand('fontSize',false,'7');
      editor.querySelectorAll('font[size="7"]').forEach(el=>{
        el.removeAttribute('size');
        el.style.fontSize=fontSizeSelect.value;
      });
      editor.focus();
      record();
      scheduleSave();
    });

    const WORD_COLORS = [
      '#000000','#1F1F1F','#595959','#A6A6A6','#D9D9D9',
      '#C00000','#FF0000','#FFC000','#92D050','#00B050',
      '#00B0F0','#0070C0','#002060','#7030A0','#FF7F50',
      '#8B4513','#F4B183','#FFD966','#BDD7EE','#D9EAD3'
    ];
    let currentColor = '#111111';

    function buildPalette(){
      if(!colorPalette) return;
      const grid = document.createElement('div');
      grid.className='color-grid';
      WORD_COLORS.forEach(c=>{
        const cell=document.createElement('div');
        cell.className='color-cell';
        cell.style.background=c;
        cell.title=c;
        cell.addEventListener('mousedown', saveSelection);
        cell.addEventListener('click', ()=>{ applyColor(c,true); });
        grid.appendChild(cell);
      });
      colorPalette.innerHTML='';
      colorPalette.appendChild(grid);
    }

    function openPalette(){ colorPalette.style.display='block'; }
    function closePalette(){ colorPalette.style.display='none'; }
    function applyColor(c, fromPalette=false){
      currentColor = c || currentColor;
      colorSwatch.style.background = currentColor;
      restoreSelection();
      document.execCommand('foreColor', false, currentColor);
      editor.focus();
      record();
      scheduleSave();
      if(fromPalette) closePalette();
    }

    buildPalette();
    colorSwatch.style.background=currentColor;

    [colorApply,colorPalette].forEach(el=>{
      el && el.addEventListener('mousedown', e=>{ e.preventDefault(); saveSelection(); });
    });

    colorApply?.addEventListener('click', (e)=>{ e.stopPropagation(); const shown = colorPalette && colorPalette.style.display==='block'; shown ? closePalette() : openPalette(); });
    document.addEventListener('click', (e)=>{
      if(colorPalette && !document.getElementById('fontColorControl').contains(e.target)) closePalette();
    });

    alignBtns.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const cmd = alignCommandMap[btn.dataset.align];
        if(!cmd) return;
        document.execCommand(cmd,false,null);
        editor.focus();
        record();
        updateAlignState();
        scheduleSave();
      });
    });

    ulBtn.addEventListener('click',()=>{ document.execCommand('insertUnorderedList'); editor.focus(); record(); updateCounts(); scheduleSave(); });
    olBtn.addEventListener('click',()=>{ document.execCommand('insertOrderedList'); editor.focus(); record(); updateCounts(); scheduleSave(); });

    indentBtn.addEventListener('click',()=>{
      const blocks = ensureBlocks();
      if(blocks.length===0) return;
      const anyActive = blocks.some(b=> (b.style.marginLeft||'')==='10cm');
      const next = anyActive ? '0cm' : '10cm';
      blocks.forEach(b=>{ b.style.marginLeft = next; });
      updateIndentState();
      record();
      scheduleSave();
    });

    const TEMPLATE_HTML = `
      <h2>Compte rendu de r√©union</h2>
      <p><strong>Date :</strong> ____ / ____ / ____</p>
      <p><strong>Participants :</strong></p>
      <ul>
        <li>Nom 1</li>
        <li>Nom 2</li>
        <li>Nom 3</li>
      </ul>
      <h3>Objectifs</h3>
      <p>Rappeler bri√®vement le but de la rencontre.</p>
      <h3>D√©cisions</h3>
      <ol>
        <li>D√©cision importante n¬∞1</li>
        <li>D√©cision importante n¬∞2</li>
      </ol>
      <p><strong>Actions √† suivre :</strong> Responsable ‚Äì √âch√©ance.</p>
    `;

    templateBtn?.addEventListener('click',()=>{
      removePlaceholder();
      editor.innerHTML = TEMPLATE_HTML;
      editor.focus();
      placeCursorAtEnd();
      record();
      updateCounts();
      scheduleSave();
    });

    clearBtn?.addEventListener('click',()=>{
      if(confirm('Vider compl√®tement le document ?')){
        setPlaceholder();
        editor.focus();
        record();
        updateCounts();
        scheduleSave();
      }
    });

    function triggerPrint(){
      document.body.classList.add('print-mode');
      let fallback;
      const cleanup = ()=>{
        document.body.classList.remove('print-mode');
        clearTimeout(fallback);
        window.removeEventListener('afterprint', cleanup);
      };
      window.addEventListener('afterprint', cleanup);
      fallback = setTimeout(cleanup, 1500);
      setTimeout(()=>{ window.print(); }, 50);
    }

    pdfBtn.addEventListener('click',()=>{
      if(isPlaceholderActive() || !editor.textContent.trim()){
        alert('Ajoutez du contenu avant d‚Äôexporter en PDF.');
        editor.focus();
        return;
      }
      persistContent(true);
      if (typeof window.proactifMarkExerciseDone === 'function') {
        window.proactifMarkExerciseDone();
      }
      triggerPrint();
    });

    window.addEventListener('beforeunload', ()=>{ persistContent(true); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') persistContent(true); });

    loadInitialContent();
  </script>
  </main>
</div>

</body>
</html>
